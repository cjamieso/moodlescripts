#!/bin/bash

DBUSER='postgres'

# Set timzone for build.
echo 'date.timezone = "America/Edmonton"' >> ~/.phpenv/versions/$(phpenv version-name)/etc/conf.d/travis.ini;
# Copy generic configuration in place
cp config-dist.php config.php ;

# Create the moodledata directory
mkdir -p -m777 "$HOME"/moodledata

# The database name and password
sed -i s/\'moodle\'/\'$DBNAME\'/ config.php
sed -i s/\'username\'/\'$DBUSER\'/ config.php
sed -i s/\'password\'/\'$dbpass\'/ config.php

# The wwwroot and dataroot
sed -i \
  -e "s%http://example.com/moodle%http://localhost%" \
  -e "s%/home/example/moodledata%/home/travis/moodledata%" \
  config.php ;

# This DB is used by phpunit
psql -c "create database $DBNAME;" -U $DBUSER;
# These DBs are used by behat
for ((i=1;i<=$MAXDB;i+=1)); do
  psql -c "create database $DBNAME$i;" -U $DBUSER;
done;


sed -i "s%</ruleset>%<rule ref=\"moodle.Commenting.InlineComment.DocBlock\">\
<severity>0</severity>\
</rule>\
</ruleset>%" local/codechecker/moodle/ruleset.xml
