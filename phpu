#!/bin/bash

function runtests {
	cd $DIR
	if [ "$TESTTYPE" = "analytics" ];
	then
		echo "running report/analytics tests"
		vendor/bin/phpunit -c report/analytics
	elif [ "$TESTTYPE" = "mail" ];
	then
		echo "running blocks/course_message tests"
		vendor/bin/phpunit -c blocks/course_message
	elif [ "$TESTTYPE" = "sg" ];
	then
		echo "running blocks/skills_group tests"
		vendor/bin/phpunit -c blocks/skills_group
	elif [ "$TESTTYPE" = "nn" ];
	then
		echo "running blocks/nurs_navigation tests"
		vendor/bin/phpunit -c blocks/nurs_navigation
	elif [ "TESTTYPE" = "labels" ];
	then
		echo "running course/format/collblct tests"
		vendor/bin/phpunit -c course/format/collblct
	else
		echo "tests suite not found"
	fi
	cd -
}

# For travis builds, use its home dir, otherwise use /vagrant
if [ -z "$TRAVIS_BUILD_DIR" ];
then
    export DIR=/vagrant
else
    export DIR=$TRAVIS_BUILD_DIR
fi

# Use file for tests if it exists, otherwise use $1
if [ -f "paths.txt" ];
then
	while read -r line || [[ -n "$line" ]];
	do
		export TESTTYPE=$line
		runtests
	done < "paths.txt"
else
	export TESTTYPE=$1
	runtests
    exitcode=${PIPESTATUS[0]}
    echo $exitcode
    echo "exit code"
    echo $?
fi
