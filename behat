#!/bin/bash

function runtests {
    if [ "$TESTTYPE" = "analytics" ];
    then
        echo "Starting report/analytics tests"
        $DIR/vendor/bin/behat --config $YMLDIR/behat.yml --tags @report_analytics
    elif [ "$TESTTYPE" = "sg" ];
    then
        echo "Starting blocks/skills_group tests"
        $DIR/vendor/bin/behat --config $YMLDIR/behat.yml --tags @block_skills_group
    elif [ "$TESTTYPE" = "mail" ];
    then
        echo "Starting blocks/course_message tests"
        $DIR/vendor/bin/behat --config $YMLDIR/behat.yml --tags @block_course_message
    elif [ "$TESTTYPE" = "wip" ];
    then
        echo "Starting work-in-progress tests"
        $DIR/vendor/bin/behat --config $YMLDIR/behat.yml --tags @wip
    else
        echo "Test type not found"
    fi
}

# For non-travis builds, start the jar and xvfb
if [ -z "$TRAVIS_BUILD_DIR" ];
then
    export DIR=/vagrant
    export YMLDIR=/b_moodledata/behat
    export DISPLAY=:10
    (java -jar /home/vagrant/selenium-server-standalone.jar > /dev/null 2>&1)& >/dev/null 2>&1
    (sudo Xvfb :10 -ac -noreset 2>/dev/null & )& > /dev/null 2>&1
else
    export DIR=$TRAVIS_BUILD_DIR
    export YMLDIR=/home/travis/roots/behat/behat
fi

# Use file for tests if it exists, otherwise use $1
if [ -f "paths.txt" ];
then
    COUNTER=0
    while read -r line || [[ -n "$line" ]];
    do
        export TESTTYPE=$line
        # Cap number of behat test runs to 2 to keep cycle under 50 minutes
        if [ $COUNTER -lt 2 ];
        then
            runtests
            let COUNTER=COUNTER+1
        fi
    done < "paths.txt"
else
    export TESTTYPE=$1
    runtests
fi



