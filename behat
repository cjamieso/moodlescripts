#!/bin/bash

options=$(getopt -o t:rdoi --long tag:,rerun,drop,init,output -- "$@")
eval set -- "$options"

while true ; do
    case "$1" in
        -t|--tag)
            t=1
            tags="$2"
            ;;
        -r|--rerun)
            rerun=1
            ;;
        -d|--drop)
            drop=1
            ;;
        -i|--init)
            init=1
            ;;
        -o|--output)
            output=1
            ;;
        --)
            shift
            break
            ;;
    esac
    shift
done

# echo command if output is set, otherwise run command
function process_command {
    if [ "$output" == 1 ];
    then
        echo $command
        exit 0
    else
        DOCKERDIR="${MOODLE_DOCKER_WWWROOT}/moodle-docker"
        eval "$DOCKERDIR/bin/moodle-docker-compose ${command}"
        exit 0
    fi

}

# check for dropping of tests first
if [ "$drop" == 1 ];
then
    command="exec webserver php admin/tool/behat/cli/util.php --drop"
    process_command
elif [ "$init" == 1 ];
then
    # TODO: this should also check for parallel
    command="exec webserver php admin/tool/behat/cli/init.php"
    process_command
fi

# expects name to be in $a
function translate_testtype {
    a=$(echo $a | sed 's,/,_,g')
    a=$(echo $a | sed 's,course_format,format,g')
    export a=$(echo $a | sed 's,blocks,block,g')
}

# docker based tests
function docker {
    command="exec webserver php admin/tool/behat/cli/run.php --tags=@$a"

    if [ "$rerun" = 1 ];
    then
        command="${command} --rerun"
    fi
    process_command
}

# travis based tests
function travis {
    export TAGS=@$a
    if [ -z "$PARALLELRUNS" ]; then
        echo "running single behat test thread"
        $DIR/vendor/bin/behat --config $YMLDIR/behat.yml --tags $TAGS
        exitcode=${PIPESTATUS[0]}
    else
        echo "running behat tests in parallel"
        lsof | grep 4444
        PARALLELPERNODE=$(($PARALLELRUNS/$CI_NODE_TOTAL))
        TORUN=$(($CI_NODE_INDEX*$PARALLELPERNODE))
        FROMRUN=$(($TORUN-$PARALLELPERNODE+1))
        php $DIR/admin/tool/behat/cli/run.php --tags=$TAGS --fromrun=$FROMRUN --torun=$TORUN --profile='firefox_{runprocess}' --replace='{runprocess}'
        exitcode=${PIPESTATUS[0]}
        if [ "${exitcode}" -gt 0 ]; then
            php $DIR/admin/tool/behat/cli/run.php --tags=$TAGS --fromrun=$FROMRUN --torun=$TORUN --profile='firefox_{runprocess}' --replace='{runprocess}' --rerun
            exitcode=${PIPESTATUS[0]}
        fi
    fi
    kill -9 $(lsof -ti tcp:4444)
    exit $exitcode
}

#now run tests
export PHP=$(type -p php)
# Set DIR and YMLDIR
if [ -z "$TRAVIS_BUILD_DIR" ]; then
    export DIR=/vagrant
    export YMLDIR=/b_moodledata/behat
else
    export DIR=$TRAVIS_BUILD_DIR
    export YMLDIR=/home/travis/roots/behatdata/behat
fi

# check for tests specified
if [ "$t" != 1 ];
then
    export PLUGINS=$($PHP -f $DIR/moodlescripts/get_diff.php)
    read -ra arr <<<"$PLUGINS"
    for a in "${arr[@]}"; do
        translate_testtype
    done
else
    export a=$tags
    translate_testtype
fi

# For non-travis builds, run commands in docker
if [ -z "$TRAVIS_BUILD_DIR" ]; then
    docker
else
    travis
fi
