#!/bin/bash

function runbehat {
    export TAGS=@$a
    if [ -z "$PARALLELRUNS" ]; then
        echo "running single behat test thread"
        $DIR/vendor/bin/behat --config $YMLDIR/behat.yml --tags $TAGS
    else
        echo "running behat tests in parallel"
        lsof | grep 4444
        lsof | grep 8000
        PARALLELPERNODE=$(($PARALLELRUNS/$CI_NODE_TOTAL))
        TORUN=$(($CI_NODE_INDEX*$PARALLELPERNODE))
        FROMRUN=$(($TORUN-$PARALLELPERNODE+1))
        php $DIR/admin/tool/behat/cli/run.php --tags=$TAGS --fromrun=$FROMRUN --torun=$TORUN --profile='firefox_{runprocess}' --replace='{runprocess}'
        php $DIR/moodlescripts/get_behat_tests.php /home/travis/moodledata_behat $FROMRUN $TORUN ${PIPESTATUS[0]}
        exitcode=${PIPESTATUS[0]}
        if [ "${exitcode}" -gt 0 ]; then
            echo "re-running tests"
            rerunbehat
            kill -9 $(lsof -ti tcp:4444)
            exit $exitcode
        else
            kill -9 $(lsof -ti tcp:4444)
            exit $exitcode
        fi
    fi
}

function rerunbehat {
    echo "re-running failed tests"
    if [ -s "rerun.txt" ]; then
        cat rerun.txt
        while read -r line || [[ -n "$line" ]];
        do
            ln -s $TRAVIS_BUILD_DIR $TRAVIS_BUILD_DIR/behatrun$line
            $DIR/vendor/bin/behat --config $BEHAT_DATAROOT$line/behat/behat.yml --profile="firefox_$line" --tags=$TAGS --rerun
            exitcode=${PIPESTATUS[0]}
            if [ "${exitcode}" -gt 0 ]; then
                kill -9 $(lsof -ti tcp:4444)
                exit $exitcode
            fi
        done < "rerun.txt"
    fi
}

# expects name to be in $a
function translate_testtype {
    a=$(echo $a | sed 's,/,_,g')
    a=$(echo $a | sed 's,course_format,format,g')
    export a=$(echo $a | sed 's,blocks,block,g')
}

# For non-travis builds, start the jar and xvfb
if [ -z "$TRAVIS_BUILD_DIR" ]; then
    export DIR=/vagrant
    export YMLDIR=/b_moodledata/behat
    start_selenium 1
else
    export DIR=$TRAVIS_BUILD_DIR
    export YMLDIR=/home/travis/roots/behatdata/behat
fi

# Check $1 for type of tests, otherwise use the diff.
if [ -z "$1" ]; then
    export PLUGINS=$(/usr/bin/php -f $DIR/moodlescripts/get_diff.php)
    read -ra arr <<<"$PLUGINS"
    for a in "${arr[@]}"; do
        translate_testtype
        runbehat
    done
else
    export a=$1
    translate_testtype
    runbehat
fi
