#!/bin/bash

function docker {
    export TAGS=@$a
    if [ ! -d "$MOODLE_DOCKER_WWWROOT" ];
    then
        echo 'Error: $MOODLE_DOCKER_WWWROOT is not set or not an existing directory'
        exit 1
    fi
    DOCKERDIR="${MOODLE_DOCKER_WWWROOT}/moodle-docker"
    if [ "$1" = "drop" ];
    then
        echo "dropping tests"
        $DOCKERDIR/bin/moodle-docker-compose exec webserver php admin/tool/behat/cli/util.php --drop
        exit 0
    fi

    if [ "$2" = "rerun" ];
    then
        $DOCKERDIR/bin/moodle-docker-compose exec webserver php admin/tool/behat/cli/run.php --tags=$TAGS --rerun
        exit 0
    fi
    $DOCKERDIR/bin/moodle-docker-compose exec webserver php admin/tool/behat/cli/run.php --tags=$TAGS
}

function travis {
    export TAGS=@$a
    if [ -z "$PARALLELRUNS" ]; then
        echo "running single behat test thread"
        $DIR/vendor/bin/behat --config $YMLDIR/behat.yml --tags $TAGS
    else
        echo "running behat tests in parallel"
        lsof | grep 4444
        lsof | grep 8000
        PARALLELPERNODE=$(($PARALLELRUNS/$CI_NODE_TOTAL))
        TORUN=$(($CI_NODE_INDEX*$PARALLELPERNODE))
        FROMRUN=$(($TORUN-$PARALLELPERNODE+1))
        php $DIR/admin/tool/behat/cli/run.php --tags=$TAGS --fromrun=$FROMRUN --torun=$TORUN --profile='firefox_{runprocess}' --replace='{runprocess}'
        exitcode=${PIPESTATUS[0]}
        if [ "${exitcode}" -gt 0 ]; then
            php $DIR/admin/tool/behat/cli/run.php --tags=$TAGS --fromrun=$FROMRUN --torun=$TORUN --profile='firefox_{runprocess}' --replace='{runprocess}' --rerun
            exitcode=${PIPESTATUS[0]}
            kill -9 $(lsof -ti tcp:4444)
            exit $exitcode
        else
            kill -9 $(lsof -ti tcp:4444)
            exit 0
        fi
    fi
}

# expects name to be in $a
function translate_testtype {
    a=$(echo $a | sed 's,/,_,g')
    a=$(echo $a | sed 's,course_format,format,g')
    export a=$(echo $a | sed 's,blocks,block,g')
}

function get_test {
    # Check $1 for type of tests, otherwise use the diff.
    if [ -z "$1" ]; then
        export PLUGINS=$($PHP -f $DIR/moodlescripts/get_diff.php)
        read -ra arr <<<"$PLUGINS"
        for a in "${arr[@]}"; do
            translate_testtype
        done
    else
        export a=$1
        translate_testtype
    fi
}

export PHP=$(type -p php)
# For non-travis builds, run commands in docker
if [ -z "$TRAVIS_BUILD_DIR" ]; then
    export DIR=/vagrant
    export YMLDIR=/b_moodledata/behat
    get_test
    docker
else
    export DIR=$TRAVIS_BUILD_DIR
    export YMLDIR=/home/travis/roots/behatdata/behat
    get_test
    travis
fi

